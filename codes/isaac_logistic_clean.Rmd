---
title: "Logistic Regression - Home Ownership"
author: "Isaac Levy"
date: "2024-08-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(openintro)
library(nationalparkcolors)
library(PrettyCols)
library(MASS)
library(broom)
library(caret)
library(car)
library(glmnet)
library(pls)
library(corrr)
library(tidyverse)


acadia <- park_palette('Acadia')
autumn <- prettycols('Autumn')
```

## Data Import and Cleaning

```{r data setup}
data('reddit_finance')

# select only respondants from the US
df <- reddit_finance[reddit_finance$country == 'United States',]

# remove all columns with more than 50% missing values
df.2 <- df[, which(colMeans(!is.na(df)) > 0.5)]

# remove all NAs in housing column
df.2 <- df.2[!is.na(df.2$housing),]

# recode housing variable to binary
df.2 <- df.2 %>%
  mutate(numown = ifelse(housing == 'Own', 1, 0))

# drop columns we know we don't care about (i.e., country is all US, other columns have many NAs, etc.)
df.6 <- df.2 %>%
  select(-c(other_val, spec_crypto, invst_prop_bus_own, '2020_invst_save', 
            '2020_healthcare_exp', country, housing))

# drop any all NAs from current data set - left with 609 obs and 42 vars
df.nona <- na.omit(df.6)

# after some lasso variable selection and stepAIC models, select some variables of interest
df.new <- select(df.nona, c(numown, fin_indy_pct, home_value,
                            retirement_accts_tax, '2020_housing_exp',
                            '2020_gross_inc', '2020_utilities_exp',
                            '2020_necessities_exp', age, rel_status, children,))

# rename some variables to not start with numbers
df.new <- rename(df.new, c('utilities_exp' = '2020_utilities_exp',
                           'necessities_exp' = '2020_necessities_exp',
                           'gross_inc' = '2020_gross_inc',
                           'housing_exp' = '2020_housing_exp'))

# drop columns with insignificant p-values in model
df.new <- df.new %>% select(-c(necessities_exp, fin_indy_pct, home_value))

# it turns out these columns have text 'N/A's, drop them
df.new <- df.new %>%
  filter(children != 'N/A',
         rel_status != 'N/A',
         age != 'N/A')

# drop more columns that have no significance, let with 596 obs and 4 3 predictors
final <- df.new %>% select(-c(retirement_accts_tax, age, rel_status, gross_inc))
```

## The Model

```{r}
mod1 <- glm(numown ~ ., data = final, family = binomial)
summary(mod1)
```

### Residuals

```{r}
quantile(residuals(mod1))
```

### VIF

```{r}
vif(mod1)
```

### Prediction Evaluation

```{r}
# predictions
y_hat <- round(predict(mod1, type = 'response'), 3)
# rounded predictions
y_hat_rounded <- ifelse(y_hat > .50, 1, 0)
# actual values
y <- final$numown
# residuals
r <- round(residuals(mod1, type = 'response'), 3)
# bind columns together
model.eval <- data.frame(cbind(y, y_hat_rounded, y_hat, r))
head(model.eval)
```

## PCA

```{r}
# select only numeric columns and numown
df.numeric <- df.2 %>%
  select(c(numown, '2020_gross_inc', '2020_housing_exp', '2020_utilities_exp', 
           '2020_transp_exp', '2020_necessities_exp', '2020_lux_exp',
           '2020_invst_save', '2020_healthcare_exp', '2020_taxes', cash,
           retirement_accts_tax,brokerage_accts_tax, home_value, retire_exp,
           tgt_sf_wthdrw_rt, retire_invst_num, fin_indy_num, fin_indy_pct)) %>%
  na.omit()

df.pca <- princomp(df.numeric[-1], fix_sign = T, cor = T)

pca.dat <- data.frame(numown=df.numeric$numown, df.pca$scores)

logit.pca <- glm(numown~., data = pca.dat, family = binomial)
logit.pca.aic <- stepAIC(logit.pca, direction = 'both', trace = F, method = 'glm')

summary(logit.pca.aic)
```

```{r}
# predictions
y_hat.pca <- round(predict(logit.pca.aic, type = 'response'), 3)
# rounded predictions
y_hat_rounded.pca <- ifelse(y_hat.pca > .50, 1, 0)
# actual values
y.pca <- pca.dat$numown
# residuals
r.pca <- round(residuals(logit.pca.aic, type = 'response'), 3)
# bind columns together
model.eval.pca <- data.frame(cbind(y.pca, y_hat_rounded.pca, y_hat.pca, r.pca))
head(model.eval.pca)
```

```{r}
quantile(residuals(logit.pca.aic))
```


```{r}
# PCA residuals look really good

model.eval.pca %>%
  ggplot() +
  aes(x=r.pca) +
  geom_density(stat = 'count')
```

```{r}
# Non-PCA residuals look worse than PCA residuals

model.eval %>%
  ggplot() +
  aes(x=r) +
  geom_histogram(stat = 'count')
```

```{r}
plot(df.pca, type='l')
```

